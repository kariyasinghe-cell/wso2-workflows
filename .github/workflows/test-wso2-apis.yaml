name: Reusable workflow for deploying APIM APIs

on:
  workflow_call:
    inputs:
      includeAPIs:
        description: 'Comma-separated list of APIM APIs to include'
        required: true
        type: string

      branch:
        description: 'The Git branch which use with the enviorenment'
        required: true
        type: string
        
      triggeredBy:
        description: "Flag to indicate this is from child workflow"
        required: false
        default: "false"
        type: string

      environment:
        description: "API Deployment Environment"
        required: true
        default: "Dev"
        type: string

jobs:
  process-apim:
    runs-on: ubuntu-latest
    outputs:
      folders: ${{ steps.get_apis.outputs.folders }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          repository: kariyasinghe-cell/wso2-workflows
          ref: ${{ github.ref }}

      - name: Determine APIs to process
        id: get_apis
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"
          APIM_PATH="$GITHUB_WORKSPACE/apim"

          INPUT="${{ inputs.includeAPIs }}"

          # If input is empty, include all folders
          if [ -z "$INPUT" ] && [ "${{ inputs.triggeredBy }}" == "developer" ]; then
            echo "‚ùå No input given from child workflow ‚Äî stopping pipeline!"
            exit 1
          elif [ -z "$INPUT" ] && [ "${{ inputs.triggeredBy }}" == "apim-team" ]; then
            echo "No input given ‚Äî including all APIs under apim/"
            FOLDERS=$(ls -1 "$APIM_PATH")
          else
            echo "User provided input : $INPUT"
            IFS=',' read -r -a ARR <<< "$INPUT"

            VALID_FOLDERS=()
            INVALID_FOLDERS=()

            for folder in "${ARR[@]}"; do
              folder=$(echo "$folder" | xargs)  # trim spaces
              if [ -d "$APIM_PATH/$folder" ]; then
                VALID_FOLDERS+=("$folder")
              else
                INVALID_FOLDERS+=("$folder")
              fi
            done

            if [ ${#INVALID_FOLDERS[@]} -ne 0 ]; then
              echo "‚ö†Ô∏è Warning: These APIs do not exist under 'apim/' and will be ignored: ${INVALID_FOLDERS[*]}"
            fi

            if [ ${#VALID_FOLDERS[@]} -eq 0 ]; then
              echo "‚ùå No valid APIs found from input!"
              exit 1
            fi

            # Join valid folders into a space-separated string
            FOLDERS="${VALID_FOLDERS[*]}"
          fi

          echo "‚úÖ APIs to process: $FOLDERS"

          # Output for subsequent steps
          {
            echo "folders<<EOF"
            echo "$FOLDERS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Use APIM folders
        run: |
          echo "Folders from previous step:"
          echo "${{ steps.get_apis.outputs.folders }}"

  loop-folders:
    runs-on: ubuntu-latest
    needs: process-apim
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
  
      - name: Loop through and print each folder
        run: |
          # Read output from previous job
          FOLDERS="${{ needs.process-apim.outputs.folders }}"
          echo "Folders received: '$FOLDERS'"
  
          # Only loop if not empty
          if [ -z "$FOLDERS" ]; then
            echo "‚ùå No folders to process!"
            exit 1
          fi
  
          # Loop through space-separated folders
          for folder in $FOLDERS; do
            echo "üîÅ Processing folder: $folder"
          done
